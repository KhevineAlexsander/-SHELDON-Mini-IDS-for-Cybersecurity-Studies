import os
import csv
import time
import socket
from datetime import datetime
from collections import defaultdict
from scapy.all import sniff, IP, TCP, UDP, sr1

# ================= ASSINATURA =================

def banner():
    print("\033[96m")
    print("               âš›")
    print("        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—")
    print("        â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘")
    print("        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘")
    print("        â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘")
    print("        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘")
    print("        â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•")
    print("\n                Criado por KhÃ©vine Nunes")
    print("\033[0m")

# ================= CONFIGURAÃ‡Ã•ES =================

logs = []
salvar_em_arquivo = False
diretorio_salvamento = ""
formato_log = "txt"
nome_personalizado = ""

portas_filtradas = []
contador_ips = defaultdict(int)
portas_por_ip = defaultdict(set)
tempo_primeiro_pacote = defaultdict(float)

LIMITE_PORTAS = 10
JANELA_TEMPO = 10

VERDE = "\033[92m"
VERMELHO = "\033[91m"
AMARELO = "\033[93m"
RESET = "\033[0m"

# ================= FUNÃ‡Ã•ES DE VALIDAÃ‡ÃƒO =================

def input_opcao(mensagem, opcoes_validas):
    while True:
        escolha = input(mensagem).strip()
        if escolha in opcoes_validas:
            return escolha
        print("âŒ OpÃ§Ã£o invÃ¡lida.")

def input_sn(mensagem):
    while True:
        escolha = input(mensagem + " (S/n): ").strip()

        if escolha == "":
            return True

        if escolha.upper() == "S":
            return True
        elif escolha.upper() == "N":
            return False

        print("âŒ Digite apenas S ou N.")

# ================= ANALISAR PACOTES =================

def analisar_pacote(pacote):
    global logs

    if pacote.haslayer(IP):
        ip_origem = pacote[IP].src
        ip_destino = pacote[IP].dst
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        porta_destino = None
        protocolo = "IP"

        if pacote.haslayer(TCP):
            porta_destino = pacote[TCP].dport
            protocolo = "TCP"
        elif pacote.haslayer(UDP):
            porta_destino = pacote[UDP].dport
            protocolo = "UDP"

        if portas_filtradas:
            if porta_destino not in portas_filtradas:
                return

        contador_ips[ip_origem] += 1
        suspeito = False

        if porta_destino:
            agora = time.time()

            if tempo_primeiro_pacote[ip_origem] == 0:
                tempo_primeiro_pacote[ip_origem] = agora

            portas_por_ip[ip_origem].add(porta_destino)

            if (agora - tempo_primeiro_pacote[ip_origem]) <= JANELA_TEMPO:
                if len(portas_por_ip[ip_origem]) >= LIMITE_PORTAS:
                    suspeito = True
            else:
                portas_por_ip[ip_origem].clear()
                tempo_primeiro_pacote[ip_origem] = agora

        mensagem = f"[{timestamp}] [{protocolo}] {ip_origem} -> {ip_destino}"
        if porta_destino:
            mensagem += f" Porta: {porta_destino}"

        if suspeito:
            print(f"{VERMELHO}ğŸš¨ POSSÃVEL PORT SCAN DETECTADO! {mensagem}{RESET}")
        else:
            print(f"{VERDE}{mensagem}{RESET}")

        if salvar_em_arquivo:
            logs.append([timestamp, protocolo, ip_origem, ip_destino, porta_destino, suspeito])

# ================= SALVAR LOG =================

def salvar_log():
    try:
        if not os.path.exists(diretorio_salvamento):
            os.makedirs(diretorio_salvamento, exist_ok=True)

        nome_final = nome_personalizado if nome_personalizado else f"log_rede_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        caminho = os.path.join(diretorio_salvamento, f"{nome_final}.{formato_log}")

        if formato_log == "txt":
            with open(caminho, "w") as f:
                for linha in logs:
                    f.write(str(linha) + "\n")

        elif formato_log == "csv":
            with open(caminho, "w", newline="") as f:
                writer = csv.writer(f)
                writer.writerow(["Timestamp", "Protocolo", "IP Origem", "IP Destino", "Porta", "Suspeito"])
                writer.writerows(logs)

        print(f"\nâœ… Log salvo em: {caminho}")

        print(f"\n{AMARELO}ğŸ“Š IPs mais ativos:{RESET}")
        for ip, total in sorted(contador_ips.items(), key=lambda x: x[1], reverse=True)[:5]:
            print(f"{ip} -> {total} pacotes")

    except Exception as e:
        print(f"{VERMELHO}âŒ Erro ao salvar arquivo: {e}{RESET}")

# ================= MENU =================

def menu():
    global salvar_em_arquivo, diretorio_salvamento, formato_log, nome_personalizado

    banner()

    print("===== MINI IDS =====")
    print("1 - Monitoramento Tempo Real")
    print("2 - Monitoramento Tempo Determinado")
    print("3 - Escanear Portas")
    opcao = input_opcao("Escolha (1,2,3): ", ["1", "2", "3"])

    if opcao in ["1", "2"]:
        salvar_em_arquivo = input_sn("Deseja salvar log?")

        if salvar_em_arquivo:
            diretorio_salvamento = os.path.join(os.path.expanduser("~"), "Downloads")
            formato_log = input_opcao("Formato (txt/csv): ", ["txt", "csv"])
            nome_personalizado = input("Nome do arquivo (ENTER para automÃ¡tico): ").strip()

    if opcao == "1":
        print("\nğŸ” Monitorando... CTRL+C para parar\n")
        try:
            sniff(prn=analisar_pacote, store=False)
        except KeyboardInterrupt:
            if salvar_em_arquivo:
                salvar_log()

    elif opcao == "2":
        tempo = int(input("Tempo em segundos: "))
        sniff(prn=analisar_pacote, store=False, timeout=tempo)
        if salvar_em_arquivo:
            salvar_log()

    elif opcao == "3":
        print("\nâš ï¸ Use apenas em ambientes autorizados!\n")
        alvo = input("Digite o IP ou domÃ­nio: ")
        print("FunÃ§Ã£o de scan ativa.")

# ================= START =================

if __name__ == "__main__":
    menu()
